
apiVersion: batch/v1
kind: CronJob
metadata:
  name: openbao-backup
spec:
  schedule: "0 0 * * *" # Run once a day at midnight
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: openbao-backup
          containers:
          - name: openbao-backup
            image: openbao-backup:latest # This should be replaced with the actual image name from your registry
            env:
            - name: BAO_ADDR
              value: "http://openbao:8200"
            - name: KEEP_DAILY
              value: "7"
            - name: KEEP_WEEKLY
              value: "4"
            - name: KEEP_MONTHLY
              value: "6"
            envFrom:
            - secretRef:
                name: restic-creds-k8s
            volumeMounts:
            - name: secrets-store-inline
              mountPath: "/mnt/secrets-store"
              readOnly: true
          volumes:
          - name: secrets-store-inline
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: "openbao-restic-creds"
          restartPolicy: OnFailure
